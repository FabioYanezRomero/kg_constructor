================================================================================
KNOWLEDGE GRAPH EXTRACTION - SINGLE TEXT TEST (LM Studio)
Using LangExtract for: Source Grounding, Few-shot Learning, Long Doc Optimization
================================================================================
Model Provider: lmstudio
Model Name: local-model
LM Studio URL: http://localhost:1234/v1
Input JSON: /app/data/legal/processed/legal_background.jsonl
Record ID: UKSC-2009-0143
Text Field: text
Output Directory: /app/test_outputs/single_extraction_lmstudio_20260110_162033

LangExtract Configuration:
  â€¢ Extraction passes: 1
  â€¢ Max workers: 5
  â€¢ Max char buffer: 8000

Extraction Method: Two-Step Connectivity-Aware
  â€¢ Max disconnected: 1
  â€¢ Max iterations: 5
================================================================================

Checking LM Studio connection...
âœ“ LM Studio is reachable at http://localhost:1234/v1
  Available models: ['google/gemma-3-12b', 'qwen/qwen3-14b', 'unsloth/gpt-oss-20b', 'qwen/qwen3-8b', 'text-embedding-nomic-embed-text-v1.5']

Running extraction pipeline with LangExtract (LM Studio)...


================================================================================
STEP 1: LOADING INPUT DATA
================================================================================
Loading JSONL file: /app/data/legal/processed/legal_background.jsonl
âœ“ Found record at line 1
âœ“ Loaded record: UKSC-2009-0143
âœ“ Text field: text
âœ“ Text length: 1697 characters

Text preview (first 200 chars):
Sigma Finance Corporation is a structured investment vehicle (SIV) established to invest in certain types of asset-backed securities and other financ ial instruments. Sigma aimed to profit from the di...

================================================================================
STEP 2: INITIALIZING EXTRACTION PIPELINE (WITH LANGEXTRACT + LM STUDIO)
================================================================================
Using two-step extraction prompts:
  â€¢ Step 1 (initial): /app/src/kg_constructor/prompts/legal_background_prompt_step1_initial.txt
  â€¢ Step 2 (bridging): /app/src/kg_constructor/prompts/legal_background_prompt_step2_bridging.txt
âœ“ Client: LMStudioClient
âœ“ Model: lmstudio/local-model
âœ“ LM Studio URL: http://localhost:1234/v1
âœ“ Temperature: 0.0

LangExtract Features Enabled:
  âœ“ Source Grounding (char_start, char_end for each triple)
  âœ“ Few-shot Examples (guiding extraction quality)
  âœ“ Controlled Generation (JSON schema constraints)
  âœ“ Long Document Optimization (passes=1, workers=5)

================================================================================
STEP 3: EXTRACTING TRIPLES WITH LANGEXTRACT (LM STUDIO)
================================================================================
Using Two-Step Connectivity-Aware Extraction
  â€¢ Max disconnected components: 1
  â€¢ Max iterations: 5

WARNING:absl:Prompt alignment: non-exact match: [example#0] class='Triple' status=AlignmentStatus.MATCH_FUZZY text='John Smith ... senior software engineer' char_span=(0, 61)
WARNING:absl:Prompt alignment: non-exact match: [example#2] class='Triple' status=AlignmentStatus.MATCH_FUZZY text='Sarah Johnson ... represents the plaintiff' char_span=(0, 63)
[94m[1mLangExtract[0m: model=[92mlocal-model[0m [00:00][94m[1mLangExtract[0m: model=[92mlocal-model[0m, current=[92m4,061[0m chars, processed=[92m0[0m chars:  [00:00]DEBUG [LMStudio]: Raw response length: 2239
DEBUG [LMStudio]: Raw response (first 500 chars): ```json
[
  {
    "head": "Sigma Finance Corporation",
    "relation": "is_type_of",
    "tail": "structured investment vehicle",
    "inference": "explicit"
  },
  {
    "head": "Sigma Finance Corporation",
    "relation": "aimed_to",
    "tail": "profit from the difference between the cost of funding its activities and the returns made on its investment portfolio",
    "inference": "explicit"
  },
  {
    "head": "impact",
    "relation": "stemming_from",
    "tail": "the sub-prime mortgage ma...
[94m[1mLangExtract[0m: model=[92mlocal-model[0m, current=[92m4,061[0m chars, processed=[92m0[0m chars:  [00:13]
Traceback (most recent call last):
  File "/usr/local/lib/python3.11/site-packages/langextract/resolver.py", line 260, in resolve
    extraction_data = self.format_handler.parse_output(
                      ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langextract/core/format_handler.py", line 214, in parse_output
    raise exceptions.FormatParseError(
langextract.core.exceptions.FormatParseError: Content must be a mapping with an 'extractions' key.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/app/src/kg_constructor/clients/lmstudio_client.py", line 224, in extract
    result = lx.extract(
             ^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langextract/__init__.py", line 55, in extract
    return extract_func(*args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langextract/extraction.py", line 330, in extract
    result = annotator.annotate_text(
             ^^^^^^^^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langextract/annotation.py", line 560, in annotate_text
    annotations = list(
                  ^^^^^
  File "/usr/local/lib/python3.11/site-packages/langextract/annotation.py", line 255, in annotate_documents
    yield from self._annotate_documents_single_pass(
  File "/usr/local/lib/python3.11/site-packages/langextract/annotation.py", line 388, in _annotate_documents_single_pass
    resolved_extractions = resolver.resolve(
                           ^^^^^^^^^^^^^^^^^
  File "/usr/local/lib/python3.11/site-packages/langextract/resolver.py", line 271, in resolve
    raise ResolverParsingError(str(e)) from e
langextract.resolver.ResolverParsingError: Content must be a mapping with an 'extractions' key.

The above exception was the direct cause of the following exception:

Traceback (most recent call last):
  File "/app/test_outputs/single_extraction_lmstudio_20260110_162033/extract_single.py", line 456, in <module>
    main()
  File "/app/test_outputs/single_extraction_lmstudio_20260110_162033/extract_single.py", line 164, in main
    triples, metadata = pipeline.extractor.extract_connected_graph(
                        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/src/kg_constructor/extractor.py", line 317, in extract_connected_graph
    triples = self.extract_from_text(text, record_id, temperature, max_tokens)
              ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "/app/src/kg_constructor/extractor.py", line 197, in extract_from_text
    raw_triples = self.client.extract(
                  ^^^^^^^^^^^^^^^^^^^^
  File "/app/src/kg_constructor/clients/lmstudio_client.py", line 242, in extract
    raise LLMClientError(f"LM Studio extraction failed: {e}") from e
kg_constructor.clients.base.LLMClientError: LM Studio extraction failed: Content must be a mapping with an 'extractions' key.
