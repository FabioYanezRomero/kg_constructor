# Knowledge Graph Visualization Guide

This guide explains the **two types of visualizations** provided by the kg_constructor system.

## Overview

The system creates **TWO complementary visualizations**:

1. **Graph Visualizations** (Network View) - Shows the structure of relationships
2. **Entity Visualizations** (Text Highlights) - Shows where entities appear in the original text

Both types are generated automatically by the pipeline.

## 1. Graph Visualizations (Network View)

**Location**: `outputs/graph_visualizations/`

**Technology**: Plotly + NetworkX (from postprocessing module)

**What it shows**:
- **Nodes**: Entities (people, organizations, locations, etc.)
- **Edges**: Relationships between entities
- **Interactive**: Zoom, pan, hover for details

**Example**:
```
John ──[works at]──> Google
  └───[located in]──> California
```

**Features**:
- Interactive network graph
- Hover tooltips showing:
  - Entity names
  - Relationship types
  - Inference type (explicit/contextual)
  - Justifications
- Color-coded by entity type or relation
- Zoomable and pannable

**Generated by**: [postprocessing/networkX/visualisation.py](src/postprocessing/networkX/visualisation.py)

## 2. Entity Visualizations (Text Highlights)

**Location**: `outputs/entity_visualizations/`

**Technology**: langextract built-in visualization

**What it shows**:
- Original text with **entities highlighted**
- **Animated** sequential highlighting
- **Relation information in entity attributes** (hover/click to see)
- Color legend for entity types

**Example**:
```
[John] works at [Google] in [California].
 └─Person    └─Organization  └─Location
   Hover:      Hover:          Hover:
   relation: "works at"    relation: "works at"    relation: "located in"
   role: "head"           role: "tail"           role: "tail"
```

**Features**:
- Animated highlighting (one entity at a time)
- Color-coded by entity type or relation
- Shows entity location in original text
- **Relation info shown in entity attributes** (interactive)
- Legend explaining colors
- Animation speed control

**Generated by**: [kg_constructor/visualizer.py](src/kg_constructor/visualizer.py)

## Why Two Types?

### Graph Visualization shows STRUCTURE (Visual)
- **"What relates to what?"**
- Shows the complete knowledge graph structure as a network
- Relations displayed as **arrows/edges** connecting entities
- Reveals patterns and connections visually
- Good for understanding relationships and graph structure

### Entity Visualization shows LOCATION + RELATIONS (Text-based)
- **"Where did this come from?"**
- Shows entities in their original context
- Relations shown in entity **attributes** (hover/click to see)
- Each entity shows which relation it participates in and its role
- Useful for validation and fact-checking
- Good for understanding source text

**Important**: Both visualizations include relation information, but display it differently:
- **Graph viz**: Relations as visual arrows
- **Entity viz**: Relations in entity attributes (interactive)

## Using Both Types

### In Python

```python
from pathlib import Path
from kg_constructor import ExtractionPipeline, ClientConfig

# Configure pipeline
config = ClientConfig(client_type="gemini", api_key="your-key")
pipeline = ExtractionPipeline(
    output_dir=Path("outputs"),
    client_config=config,
    enable_entity_viz=True  # Enable entity highlighting
)

# Run full pipeline (creates BOTH types)
results = pipeline.run_full_pipeline(
    csv_path=Path("data/legal/sample_data.csv"),
    limit=5,
    create_graph_viz=True,   # Network view
    create_entity_viz=True   # Text highlights
)

# Access results
print(f"Graph visualizations: {results['graph_viz_dir']}")
print(f"Entity visualizations: {results['entity_viz_dir']}")
```

### Command-Line

```bash
python -m kg_constructor.extract_cli \
  --client gemini \
  --csv data/legal/sample_data.csv \
  --output-dir outputs/results \
  --limit 3
```

This automatically creates both types of visualizations.

## Output Structure

```
outputs/
├── extracted_json/              # Raw triples as JSON
│   ├── record_001.json
│   └── record_002.json
│
├── graphml/                     # GraphML format (for NetworkX)
│   ├── record_001.graphml
│   └── record_002.graphml
│
├── graph_visualizations/        # Network view (Plotly)
│   ├── record_001.html          # Shows entities and relations as graph
│   └── record_002.html
│
└── entity_visualizations/       # Text highlights (langextract)
    ├── record_001.html          # Shows entities highlighted in text
    └── record_002.html
```

## Customization

### Entity Visualization Options

```python
from kg_constructor import EntityVisualizer

# Create custom visualizer
visualizer = EntityVisualizer(
    animation_speed=2.0,     # Slower animation (default: 1.0)
    show_legend=True,        # Show color legend (default: True)
    gif_optimized=False      # GIF-friendly styling (default: False)
)

# Visualize single record
html = visualizer.visualize_triples(
    text="John works at Google in California.",
    triples=[
        {"head": "John", "relation": "works at", "tail": "Google", "inference": "explicit"},
        {"head": "Google", "relation": "located in", "tail": "California", "inference": "explicit"}
    ],
    document_id="example",
    group_by="relation"  # or "entity_type"
)

# Save to file
visualizer.save_visualization(
    text="...",
    triples=[...],
    output_path=Path("output.html"),
    group_by="relation"
)
```

### Grouping Strategies

#### By Entity Type (default)
- Groups: "Head Entity", "Tail Entity"
- Best for seeing all entities regardless of their role

#### By Relation
- Groups: "works at (source)", "works at (target)", "located in (source)", etc.
- Best for understanding which entities participate in which relationships

## Technical Details

### Graph Visualization Pipeline
1. Triples (JSON) → NetworkX graph
2. NetworkX graph → GraphML file
3. GraphML file → Plotly interactive HTML

### Entity Visualization Pipeline
1. Triples (JSON) + Original Text
2. Find entity spans in text
3. Create langextract AnnotatedDocument
4. langextract.visualize() → HTML

### Entity Highlighting

The entity visualizer:
1. Searches for each entity (head/tail) in the original text
2. Creates a `CharInterval` marking its position
3. Groups entities by type or relation
4. Generates animated HTML with color-coding

**Important**: Only entities that appear in the original text are highlighted. If an entity was inferred or normalized, it may not appear in the visualization.

## Comparison

| Feature | Graph Viz | Entity Viz |
|---------|-----------|------------|
| Shows relationships | ✅ Yes (as arrows) | ✅ Yes (in attributes) |
| Shows graph structure | ✅ Yes (visual) | ⚠️ Partial (per entity) |
| Shows original text | ❌ No | ✅ Yes |
| Shows entity location | ❌ No | ✅ Yes |
| Interactive network | ✅ Yes | ❌ No |
| Animation | ❌ No | ✅ Yes |
| Relation display | Visual arrows | Text attributes |
| Good for validation | ✅ Yes | ✅ Yes |
| Good for exploration | ✅ Yes | ⚠️ Limited |

## Use Cases

### Use Graph Visualization when:
- Analyzing relationship patterns
- Exploring entity connections
- Understanding graph structure
- Finding central entities
- Visualizing knowledge bases

### Use Entity Visualization when:
- Validating extractions
- Checking entity spans
- Reviewing original context
- Debugging extraction errors
- Presenting to non-technical users

### Use Both when:
- Complete analysis workflow
- Quality assurance
- Research and exploration
- Demonstrations
- Documentation

## Examples

See [examples/unified_extraction_examples.py](examples/unified_extraction_examples.py) for complete working examples of both visualization types.

## Troubleshooting

### Entity not highlighted in text visualization

**Possible causes**:
1. Entity doesn't appear verbatim in original text
2. Case mismatch (entity is normalized but text has different case)
3. Entity was inferred/contextual (not explicit in text)

**Solution**: Check the JSON triples file to see if the entity text matches the original.

### Graph visualization shows disconnected nodes

**Possible causes**:
1. Entity name normalization merged different spellings
2. Not enough relations extracted
3. Entities are genuinely isolated

**Solution**: Check the GraphML file or JSON triples to understand the structure.

### Missing visualizations

**Possible causes**:
1. `enable_entity_viz=False` in pipeline
2. `create_entity_viz=False` in run_full_pipeline()
3. No valid entities found in text

**Solution**: Check pipeline configuration and extraction results.

## Summary

The kg_constructor system provides **complementary visualizations**:

1. **Graph visualizations** = "What's connected to what?" (network structure)
2. **Entity visualizations** = "Where does this come from?" (text location)

Together, they provide complete insight into your knowledge graph extractions!
